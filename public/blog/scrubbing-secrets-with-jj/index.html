<!DOCTYPE html>
<html lang="en-US" dir="ltr">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <title>Scrubbing Secrets with jj :: alper.nl - Example site for hugo-theme-tailwind</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="Last time I talked about how I use jj for small code changes while being interrupted all the time as a manager . This time we&rsquo;ll be using it in anger.
Open Sourcing a Project I&rsquo;ve been long overdue to open source my little side project Cuppings . This is always annoying because pretty much every project will have a bunch of sensitive stuff checked in at some point. In this case the repository contains a Google Maps API key (as well as the entire database, but that&rsquo;s a different story) which is something I definitely do not want to share with the internet ((Github may have an integration with Google for this so the API key may be disabled as soon as the repo is public anyway, but who knows.)).
"
/>
<meta
  name="keywords"
  content="hugo, tailwind, tailwindcss, hugo theme, hugo theme tailwind"
/>
<meta name="robots" content="noodp" /><link rel="manifest" href="/manifest.json" /><meta property="og:url" content="http://localhost:1313/blog/scrubbing-secrets-with-jj/">
  <meta property="og:site_name" content="alper.nl">
  <meta property="og:title" content="Scrubbing Secrets with jj">
  <meta property="og:description" content="Last time I talked about how I use jj for small code changes while being interrupted all the time as a manager . This time we’ll be using it in anger.
Open Sourcing a Project I’ve been long overdue to open source my little side project Cuppings . This is always annoying because pretty much every project will have a bunch of sensitive stuff checked in at some point. In this case the repository contains a Google Maps API key (as well as the entire database, but that’s a different story) which is something I definitely do not want to share with the internet ((Github may have an integration with Google for this so the API key may be disabled as soon as the repo is public anyway, but who knows.)).">
  <meta property="og:locale" content="en_US">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-03-22T12:26:28+00:00">
    <meta property="article:modified_time" content="2025-03-22T12:26:28+00:00">


  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Scrubbing Secrets with jj">
  <meta name="twitter:description" content="Last time I talked about how I use jj for small code changes while being interrupted all the time as a manager . This time we’ll be using it in anger.
Open Sourcing a Project I’ve been long overdue to open source my little side project Cuppings . This is always annoying because pretty much every project will have a bunch of sensitive stuff checked in at some point. In this case the repository contains a Google Maps API key (as well as the entire database, but that’s a different story) which is something I definitely do not want to share with the internet ((Github may have an integration with Google for this so the API key may be disabled as soon as the repo is public anyway, but who knows.)).">


<link rel="canonical" href="http://localhost:1313/blog/scrubbing-secrets-with-jj/" />

<link rel="shortcut icon" href="/favicon.ico" />
<link rel="stylesheet" href="/css/index.c3a5d1586276a68cf55558ab67f2c726fee27f4aea3add1802872f471c5f233d.css">









  
  

</head>
<body class="flex flex-col min-h-screen w-full bg-slate-50 dark:bg-gray-800">
    
<div class="fixed right-0 top-0 z-50 flex items-center justify-center bg-gray-200 p-2 text-sm uppercase text-black sm:bg-red-200 md:bg-yellow-200 lg:bg-green-200 xl:bg-blue-200 2xl:bg-pink-200">
  <span class="block sm:hidden">all</span>
  <span class="hidden sm:block md:hidden">sm</span>
  <span class="hidden md:block lg:hidden">md</span>
  <span class="hidden lg:block xl:hidden">lg</span>
  <span class="hidden xl:block 2xl:hidden">xl</span>
  <span class="hidden 2xl:block">2xl</span>
</div>

  <header class="flex flex-none justify-center z-10">
    <div class="flex flex-row gap justify-between w-full max-w-4xl lg:max-w-5xl h-12 mt-3">
  <div class="flex-none ml-2 md:ml-0">
    <a href="/" class="">
      <img class="h-12 w-12 rounded-full object-cover bg-gray-100" src="https://placehold.co/512/webp" alt="logo">
    </a>
  </div>
  
  <div class="flex-1"></div>
  <div class="flex-none">
    




  </div>
  
  <div class="flex-none mx-1"></div>
  
  <div class="flex-none md:hidden">
    <a href=/search/ class="inline-flex items-center p-2 text-sm text-slate-800 dark:text-slate-200 rounded-lg" aria-controls="navbar-menu" aria-expanded="false">
      <span class="sr-only">Search</span>
      <i class="w-8 h-8">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
    <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />
    <path d="M21 21l-6 -6" />
</svg>

      </i>
    </a>
  </div>
  <div class="darkmode-toggle flex flex-none mr-2 md:mr-0">
    <label for="darkmode-toggle" class="relative flex items-center gap-1 px-3 cursor-pointer rounded-full bg-gray-100 dark:bg-gray-600" title="Toggle dark mode">
      <input name="darkmode-toggle" id="darkmode-toggle" type="checkbox" class="sr-only peer" aria-label="Toggle dark mode">
      <div class="absolute z-10 w-15 h-8 rounded-full bg-white dark:bg-gray-700"></div>
      <i class="h-6 w-6 z-20 ml-1 flex-none rounded-full bg-yellow-400 place-self-center peer-checked:invisible">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brightness-down" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M12 12m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0"></path>
   <path d="M12 5l0 .01"></path>
   <path d="M17 7l0 .01"></path>
   <path d="M19 12l0 .01"></path>
   <path d="M17 17l0 .01"></path>
   <path d="M12 19l0 .01"></path>
   <path d="M7 17l0 .01"></path>
   <path d="M5 12l0 .01"></path>
   <path d="M7 7l0 .01"></path>
</svg>

      </i>
      <i class="h-6 w-6 z-20 mr-1 flex-none rounded-full place-self-center invisible peer-checked:visible">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-moon-stars" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
   <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
   <path d="M19 11h2m-1 -1v2"></path>
</svg>

      </i>
    </label>
  </div>
</div>

  </header>
  <main class="flex flex-auto justify-center">
    
<div id="progress" class="fixed top-0 left-0 w-full h-1 bg-blue-500"></div>
<div class="w-full max-w-4xl lg:max-w-5xl">
  <div class="flex flex-col mt-6 mx-2 md:mx-0 rounded-lg overflow-hidden shadow-md bg-white dark:bg-gray-700">
    <div>
      <a href="/blog/scrubbing-secrets-with-jj/">
        
      </a>
    </div>
    <div class="flex flex-col gap-y-3 p-6">
      <h1 class="text-4xl font-semibold text-slate-800 dark:text-slate-100">
        <a href="/blog/scrubbing-secrets-with-jj/">Scrubbing Secrets with jj</a>
      </h1>

      
      
  <ul class="flex flex-row flex-wrap text-slate-500 dark:text-slate-300">
    
      
      <li>
        <a href="/categories/english/"
          class="text-sm mr-2 px-2 py-1 rounded-sm border border-emerald-800 bg-emerald-800 text-slate-50">
          English
        </a>
      </li>
      
      <li>
        <a href="/categories/software-engineering/"
          class="text-sm mr-2 px-2 py-1 rounded-sm border border-emerald-800 bg-emerald-800 text-slate-50">
          Software-Engineering
        </a>
      </li>
      
    
    
  </ul>



      <div class="flex flex-col gap-y-1 md:flex-row md:gap-y-0 md:gap-x-4 text-slate-500 dark:text-slate-300">
  
  
  <div class="flex flex-row text-base gap-x-1">
    <i class="h-6 w-6 flex-none">
      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M4 7a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12z"></path>
   <path d="M16 3v4"></path>
   <path d="M8 3v4"></path>
   <path d="M4 11h16"></path>
   <path d="M11 15h1"></path>
   <path d="M12 15v3"></path>
</svg>

    </i>
    <time datetime="2025-03-22T12:26:28&#43;00:00">
      2025-03-22
    </time>
  </div>
</div>

      

      

      <article class="mt-6 w-full max-w-4xl lg:max-w-5xl prose prose-slate dark:prose-invert prose-quoteless post-content">
        <p>Last time I talked about <a href="/dingen/2025/02/using-jj-as-a-manager/">how I use jj for small code changes while being interrupted all the time as a manager</a>
. This time we&rsquo;ll be using it in anger.</p>
<h3 id="open-sourcing-a-project">Open Sourcing a Project</h3>
<p>I&rsquo;ve been long overdue to open source my little side project <a href="https://cuppin.gs" target="_blank" rel="noopener">Cuppings</a>
. This is always annoying because pretty much every project will have a bunch of sensitive stuff checked in at some point. In this case the repository contains a Google Maps API key (as well as the entire database, but that&rsquo;s a different story) which is something I definitely do not want to share with the internet ((Github may have an integration with Google for this so the API key may be disabled as soon as the repo is public anyway, but who knows.)).</p>
<p>The core problem is that cloud costs cannot be effectively limited on any platform. This seems to be a deliberate profit maximising move from the platforms more than because of any technical limitation. Standard operating procedure here is to rotate the key and call it a day. I wanted to be a bit more thorough than that.</p>
<p>What I&rsquo;m doing is this:</p>
<ul>
<li>Delete the API key from the account.</li>
<li>Detach my personal credit card from the Google Cloud project. - It turns out that this is impossible.</li>
<li>Scrub the secret out of the repo and its entire history.</li>
<li>Get rid of any branches that may still have the secret. - Pretty easy because I don&rsquo;t use branches on my own projects.</li>
</ul>
<p>The account management steps are easy and boring. Let&rsquo;s get to the secret scrubbing.</p>
<h3 id="scrubbing-the-secret">Scrubbing the Secret</h3>
<p>Classically you would do this with <code>git-filter-branch</code> and that&rsquo;s always a bit annoying because it only works on entire files. Here, the secret had spread through the project and I wanted to leave the other bits of code intact. It looked like <code>jj</code> should be suited for the job.</p>
<p>I started off reading the docs and trying to piece together a sequence of actions that could work.</p>
<h3 id="false-starts">False Starts</h3>
<p>There were some false starts and I couldn&rsquo;t get out of them so I threw the repo checkout away and started again. For all the praise that the <code>jj op log</code> gets I have so far never been able to use it to get myself out of a mess.</p>
<p>One thing that may be helpful in the future is to use <code>jj op abandon</code> instead of <code>jj op undo</code>. <a href="https://news.ycombinator.com/item?id=43022577" target="_blank" rel="noopener">Undo adds another operation to the oplog</a>
 which I find confusing. Often you just want to entirely get rid of the last things that you did.</p>
<p>Another issue that I had was that any editor watching the folder would run a language server and if anywhere during our trip through history the correct <code>.gitignore</code> wasn&rsquo;t in place, <code>jj</code> would start snapshotting all the build files while in the middle of this very delicate operation.</p>
<p>I got around that by disabling the language server entirely like here with <a href="https://github.com/helix-editor/helix/issues/3386#issuecomment-1504220023" target="_blank" rel="noopener">a setting for Helix</a>
.</p>
<h3 id="finding-the-right-starting-point">Finding the Right Starting Point</h3>
<p>What really made a difference here is jj&rsquo;s <a href="https://github.com/jj-vcs/jj/blob/main/docs/revsets.md" target="_blank" rel="noopener">revset syntax</a>
 with its functions for both filenames and changed text:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>jj log -r &#39;files(&#34;backend/.env&#34;)&#39; -p
</span></span><span style="display:flex;"><span>jj log -r &#39;diff_contains(&#34;GOOGLE_API_KEY=&#34;)&#39;
</span></span></code></pre></div><p>The <code>-p</code> shows the entire patch instead of a short view which is particularly handy to see which change to the <code>.env</code> file added the secret.</p>
<p>Then to have an overview of where I am, I&rsquo;ll have <a href="https://github.com/gulbanana/gg" target="_blank" rel="noopener">gg</a>
 open on the side. For git I can&rsquo;t do any serious work without <a href="https://gitup.co" target="_blank" rel="noopener">gitup</a>
 and it&rsquo;s very much the same with jj. The terminal output—however good it is—does not give me the same amount of tangible feeling that a GUI does.</p>
<p>It is possible to manipulate the repository using gg and when it works <a href="https://www.youtube.com/watch?v=cD9L3Mi1Vy4" target="_blank" rel="noopener">it&rsquo;s pretty nifty</a>
 but I&rsquo;ve found that mixing operations between the GUI and the command-line is not super reliable and can make gg crash out. That&rsquo;s why I use gg purely as a viewer and I make all the changes from the command-line.</p>
<h3 id="rewriting-history">Rewriting History</h3>
<p>I seem to have missed one occurrence on my last pass because when searching right now I find another occurrence.</p>
<figure><img src="/blog/scrubbing-secrets-with-jj/CleanShot-2025-03-18-at-22.36.09@2x.png">
</figure>

<p>Looking at the diff with <code>jj show rkq</code> shows me there&rsquo;s still an unredacted API key there.</p>
<figure><img src="/blog/scrubbing-secrets-with-jj/CleanShot-2025-03-18-at-22.37.22@2x.png">
</figure>

<p>So we might as well clear this as well.</p>
<p>Trying to change this with <code>jj edit rkq</code> throws an error because the change is immutable. Anything that has a descendent in <code>immutable_heads()</code> is immutable. This is a safety setting to make sure you don&rsquo;t accidentally rewrite shared history.</p>
<p>Our history is not shared because this is my private side project, so we can do whatever we want. With <code>jj edit rkq --ignore-immutable</code> it is possible to edit this history as well. I replace the API key with the word &ldquo;fake&rdquo;.</p>
<figure><img src="/blog/scrubbing-secrets-with-jj/CleanShot-2025-03-18-at-22.43.32@2x.png">
</figure>

<p>That works and propagates the change through history but it also creates conflicts.</p>
<h3 id="fixing-conflicts">Fixing Conflicts</h3>
<p>My view in gg looks like this now:</p>
<figure><img src="/blog/scrubbing-secrets-with-jj/CleanShot-2025-03-18-at-22.44.09@2x.png">
</figure>

<p>The command-line looks similar if you know what to look for (the red crosses).</p>
<figure><img src="/blog/scrubbing-secrets-with-jj/CleanShot-2025-03-18-at-22.45.16@2x.png">
</figure>

<p>How I go through this is to scroll down in gg to find the first occurrence of the conflict. The change has propagated to that point where it conflicted again and needs to be fixed. That&rsquo;s here.</p>
<figure><img src="/blog/scrubbing-secrets-with-jj/CleanShot-2025-03-18-at-22.47.06@2x.png">
</figure>

<p>From there I edit the first conflicted change with <code>jj edit qtv</code> to fix it. The edit command helpfully immediately prints out which files are conflicted at this point.</p>
<p>It&rsquo;s the .env file again and it looks like this.</p>
<figure><img src="/blog/scrubbing-secrets-with-jj/CleanShot-2025-03-18-at-22.48.27@2x.png">
</figure>

<p>This is pretty quick to fix with Helix. Delete all the lines which shouldn&rsquo;t be there, pick the ones you want to have and remove all conflict markers.</p>
<p>We don&rsquo;t have to add anything after fixing the conflict or do something like <code>git rebase --continue</code> because jj picks the new state up automatically, sees the conflict is gone and propagates that up.</p>
<p>This clears up a bunch of the commits and we scroll up to find the next one. After doing that a couple of times the entire history is conflict free.</p>
<h3 id="push-it-back">Push it back</h3>
<p>Now the only thing left is to check we didn&rsquo;t destroy anything and to push the bookmark back to the forge with <code>jj bookmark move main --to @</code> and <code>jj git push -b main</code>.</p>
<p>You can garbage collect things before if you want to make sure the changes are no longer there <code>jj util gc</code>.</p>
<p>After completing this operation I seem to have lost the position of some WIP branches I had on the old tree, but as this is a side project I can live with that. I&rsquo;m curious if it would have been possible to keep these.</p>
<h3 id="feedback">Feedback</h3>
<p>I wrote this in part from memory after having done other things for a few weeks so I may have gotten some points wrong but all in all this should roughly work. Any suggestions or additions are welcome.</p>
<p><strong>Update:</strong> One addition is that this will remove the change from git history but the strings will likely still be in the <code>op log</code> and <code>evolog</code>. Whether they are truly gone from any git housekeeping files is also not completely verified.</p>

      </article>

      

    </div>
  </div>
</div>

  </main>
  <footer class="flex flex-none justify-center">
    <section class="flex flex-col md:flex-row mx-2 md:mx-0 gap-2 md:gap-0 justify-between w-full max-w-4xl lg:max-w-5xl py-6 text-slate-500 dark:text-slate-300">
  <div class="flex flex-row">
    
  
  
  
  
  
  
  
  
  
  
  


  </div>
  <div class="grow"></div>
  <div class="flex flex-row">
    <i class="h-6 w-6 flex-none"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0"></path>
   <path d="M14 9.75a3.016 3.016 0 0 0 -4.163 .173a2.993 2.993 0 0 0 0 4.154a3.016 3.016 0 0 0 4.163 .173"></path>
</svg>
</i> 2023 - 2025 
    
  </div>
  
  <div class="flex flex-row">
    <span class="ml-0 pl-0 md:ml-2 md:pl-2 border-l-0 md:border-l border-slate-300 dark:border-slate-400">
      Powered by <a href="https://gohugo.io" target="_blank" rel="noopener" class="underline">Hugo</a> <span class="text-red-600">&hearts;</span> <a href="https://github.com/tomowang/hugo-theme-tailwind" target="_blank" rel="noopener" class="underline">Tailwind</a>
    </span>
  </div>
  
</section>

  </footer>
  <script src="/main.js"></script>

<div class="hidden top-1 right-1" id="code-copy">
  <i class="h-6 w-6 block">
    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" />
  <path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" />
</svg>

  </i>
</div>
<div class="hidden top-1 right-1" id="code-copy-done">
  <i class="h-6 w-6 block">
    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-check" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M5 12l5 5l10 -10" />
</svg>

  </i>
</div><script src="/code-copy.js"></script>





</body>
</html>
